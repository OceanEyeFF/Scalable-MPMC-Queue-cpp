# 本地开发环境配置

> 本项目的标准开发环境规范
>
> 文档版本: v1.0
> 创建日期: 2026-01-17
> 适用平台: Windows (主要) + Linux (CI/测试)

---

## 1. 编译器配置

### 1.1 主编译器: Clang++

**版本要求**: Clang 14.0+

**安装路径** (Windows):
```
推荐使用: LLVM/Clang官方Windows版本
下载地址: https://github.com/llvm/llvm-project/releases
或使用: Visual Studio 2022附带的Clang
```

**验证安装**:
```bash
clang++ --version
# 预期输出: clang version 14.0.0 或更高
```

### 1.2 备选编译器

#### Windows平台
- **MSVC 2022** (Visual Studio 2022)
  - 用于Windows平台特定测试
  - 支持`/std:c++17`或更高

#### Linux平台 (CI/测试用)
- **GCC 11+**: 用于Linux CI验证
- **Clang 14+**: 保持与Windows一致

---

## 2. 构建工具

### 2.1 CMake

**版本**: CMake 3.20+

**Windows安装**:
```bash
# 方式1: 通过winget安装
winget install Kitware.CMake

# 方式2: 直接下载安装包
# https://cmake.org/download/
```

**验证**:
```bash
cmake --version
# 预期: cmake version 3.20.0 或更高
```

### 2.2 构建系统

**首选**: Ninja

```bash
# 安装Ninja (Windows)
winget install Ninja-build.Ninja

# 或通过Chocolatey
choco install ninja
```

**验证**:
```bash
ninja --version
# 预期: 1.10.0 或更高
```

**备选**: MSBuild (Visual Studio自带)

---

## 3. 本地开发配置

### 3.1 项目CMake配置

创建 `CMakePresets.json` (推荐):

```json
{
  "version": 3,
  "cmakeMinimumRequired": {
    "major": 3,
    "minor": 20,
    "patch": 0
  },
  "configurePresets": [
    {
      "name": "windows-clang-debug",
      "displayName": "Windows Clang Debug",
      "description": "使用Clang编译Debug版本",
      "generator": "Ninja",
      "binaryDir": "${sourceDir}/build/debug",
      "cacheVariables": {
        "CMAKE_BUILD_TYPE": "Debug",
        "CMAKE_CXX_COMPILER": "clang++",
        "CMAKE_C_COMPILER": "clang",
        "CMAKE_CXX_STANDARD": "17",
        "CMAKE_CXX_FLAGS": "-Wall -Wextra -g",
        "LSCQ_BUILD_TESTS": "ON",
        "LSCQ_BUILD_BENCHMARKS": "ON",
        "LSCQ_ENABLE_SANITIZERS": "ON"
      }
    },
    {
      "name": "windows-clang-release",
      "displayName": "Windows Clang Release",
      "description": "使用Clang编译Release版本",
      "generator": "Ninja",
      "binaryDir": "${sourceDir}/build/release",
      "cacheVariables": {
        "CMAKE_BUILD_TYPE": "Release",
        "CMAKE_CXX_COMPILER": "clang++",
        "CMAKE_C_COMPILER": "clang",
        "CMAKE_CXX_STANDARD": "17",
        "CMAKE_CXX_FLAGS": "-O3 -march=native",
        "LSCQ_BUILD_TESTS": "ON",
        "LSCQ_BUILD_BENCHMARKS": "ON"
      }
    },
    {
      "name": "windows-msvc-debug",
      "displayName": "Windows MSVC Debug",
      "description": "使用MSVC编译Debug版本",
      "generator": "Visual Studio 17 2022",
      "binaryDir": "${sourceDir}/build/msvc-debug",
      "cacheVariables": {
        "CMAKE_BUILD_TYPE": "Debug",
        "CMAKE_CXX_STANDARD": "17",
        "LSCQ_BUILD_TESTS": "ON",
        "LSCQ_BUILD_BENCHMARKS": "ON"
      }
    }
  ],
  "buildPresets": [
    {
      "name": "debug",
      "configurePreset": "windows-clang-debug"
    },
    {
      "name": "release",
      "configurePreset": "windows-clang-release"
    }
  ],
  "testPresets": [
    {
      "name": "debug",
      "configurePreset": "windows-clang-debug",
      "output": {"outputOnFailure": true}
    }
  ]
}
```

### 3.2 使用CMake Presets构建

```bash
# 配置Debug版本
cmake --preset windows-clang-debug

# 构建
cmake --build build/debug

# 运行测试
ctest --test-dir build/debug --output-on-failure

# 配置Release版本
cmake --preset windows-clang-release
cmake --build build/release

# 运行benchmark
./build/release/benchmark/benchmark_all
```

### 3.3 性能测试构建 (Release-Perf)

**用途**: 专门用于性能测试和基准测试，启用激进的编译器优化。

**优化选项**:
- `-O2` / `-O3`: 最大化优化
- `-march=native`: 针对当前CPU架构优化（AMD Ryzen 9 5900X 支持 AVX2）
- `-mtune=native`: 针对当前CPU调优
- `-ffast-math`: 激进的浮点运算优化
- `-funroll-loops`: 循环展开

**构建步骤**:
```bash
# 配置性能测试版本
cmake --preset windows-clang-release-perf

# 构建
cmake --build --preset windows-clang-release-perf

# 或者使用手动配置（如果预设遇到问题）:
cmake -B build/perf -G Ninja -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_C_COMPILER="<clang-cl路径>" \
  -DCMAKE_CXX_COMPILER="<clang-cl路径>" \
  -DCMAKE_MT="<mt.exe路径>" \
  -DLSCQ_ENABLE_PERF_OPTS=ON \
  -DLSCQ_BUILD_BENCHMARKS=ON
cmake --build build/perf --target lscq_benchmarks

# 运行benchmark
./build/release-perf/benchmarks/lscq_benchmarks.exe --benchmark_repetitions=5 --benchmark_out=results.json --benchmark_out_format=json
```

**注意事项**:
- 这些优化选项可能导致生成的代码不可移植，仅用于本地性能测试
- 性能测试前建议关闭后台程序（浏览器、IDE、杀毒软件等）
- 建议禁用CPU节能模式，设置为高性能模式
- 每次测试至少运行3-5次取中位数以减少波动

### 3.4 传统构建方式 (不使用Presets)

```bash
# 创建构建目录
mkdir build
cd build

# 配置 (Debug)
cmake .. -G Ninja \
  -DCMAKE_BUILD_TYPE=Debug \
  -DCMAKE_CXX_COMPILER=clang++ \
  -DCMAKE_C_COMPILER=clang \
  -DLSCQ_BUILD_TESTS=ON \
  -DLSCQ_BUILD_BENCHMARKS=ON \
  -DLSCQ_ENABLE_SANITIZERS=ON

# 构建
ninja

# 或使用cmake --build
cmake --build . -j8
```

---

## 4. 开发工具

### 4.1 IDE推荐

**主推荐**: Visual Studio Code + Clangd

**配置文件** (`.vscode/settings.json`):
```json
{
  "C_Cpp.intelliSenseEngine": "disabled",
  "clangd.arguments": [
    "--compile-commands-dir=${workspaceFolder}/build/debug",
    "--header-insertion=never",
    "--clang-tidy",
    "--completion-style=detailed"
  ],
  "clangd.path": "clangd",
  "cmake.configureSettings": {
    "CMAKE_EXPORT_COMPILE_COMMANDS": "ON"
  },
  "cmake.preferredGenerators": ["Ninja"],
  "files.associations": {
    "*.hpp": "cpp",
    "atomic": "cpp",
    "memory": "cpp"
  }
}
```

**必装插件**:
- C/C++ Extension Pack (Microsoft)
- clangd (LLVM)
- CMake Tools
- CMake Language Support

**次推荐**: Visual Studio 2022
- 直接支持CMake项目
- 集成调试器
- 性能分析工具

### 4.2 代码格式化

**使用**: clang-format

**配置文件** (`.clang-format`):
```yaml
---
Language: Cpp
BasedOnStyle: Google
IndentWidth: 4
ColumnLimit: 100
PointerAlignment: Left
AlignConsecutiveAssignments: false
AlignConsecutiveDeclarations: false
AllowShortFunctionsOnASingleLine: Inline
AllowShortIfStatementsOnASingleLine: Never
IndentCaseLabels: true
NamespaceIndentation: None
BreakBeforeBraces: Attach
```

**VSCode集成**:
```json
{
  "editor.formatOnSave": true,
  "C_Cpp.clang_format_style": "file"
}
```

### 4.3 静态分析

**Clang-Tidy配置** (`.clang-tidy`):
```yaml
---
Checks: >
  clang-diagnostic-*,
  clang-analyzer-*,
  modernize-*,
  performance-*,
  readability-*,
  -modernize-use-trailing-return-type,
  -readability-magic-numbers

CheckOptions:
  - key: readability-identifier-naming.ClassCase
    value: CamelCase
  - key: readability-identifier-naming.FunctionCase
    value: lower_case
  - key: readability-identifier-naming.VariableCase
    value: lower_case
  - key: readability-identifier-naming.ConstantCase
    value: UPPER_CASE
```

---

## 5. 测试环境

### 5.1 单元测试: Google Test

**版本**: 1.12.0+

**自动下载** (通过CMake FetchContent):
```cmake
# 已在CMakeLists.txt中配置
include(FetchContent)
FetchContent_Declare(
  googletest
  GIT_REPOSITORY https://github.com/google/googletest.git
  GIT_TAG release-1.12.1
)
FetchContent_MakeAvailable(googletest)
```

**运行测试**:
```bash
# 运行所有测试
ctest --test-dir build/debug

# 运行特定测试
./build/debug/tests/unit/test_cas2

# 详细输出
ctest --test-dir build/debug --verbose
```

### 5.2 Benchmark: Google Benchmark

**版本**: 1.8.0+

**运行benchmark**:
```bash
# 基础运行
./build/release/benchmark/benchmark_all

# 指定最小运行时间
./build/release/benchmark/benchmark_all --benchmark_min_time=1.0

# 输出JSON
./build/release/benchmark/benchmark_all --benchmark_out=results.json --benchmark_out_format=json

# 重复10次取平均
./build/release/benchmark/benchmark_all --benchmark_repetitions=10
```

### 5.3 Sanitizers

**Address Sanitizer** (内存错误检测):
```bash
cmake --preset windows-clang-debug -DLSCQ_ENABLE_SANITIZERS=ON
cmake --build build/debug
./build/debug/tests/unit/test_all
```

**Thread Sanitizer** (data race检测):
```cmake
# 需要单独配置
cmake .. -DCMAKE_CXX_FLAGS="-fsanitize=thread -g" -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread"
```

---

## 6. 性能分析工具 (Windows)

### 6.1 Visual Studio Profiler

**使用方法**:
1. 在Visual Studio中打开项目
2. 调试 → 性能探查器
3. 选择"CPU使用率"或"内存使用率"
4. 运行benchmark

### 6.2 Intel VTune (可选)

**下载**: Intel oneAPI Base Toolkit

**使用**:
```bash
vtune -collect hotspots ./build/release/benchmark/benchmark_pair
vtune-gui
```

### 6.3 Windows Performance Recorder (WPR)

```bash
# 开始记录
wpr -start CPU

# 运行程序
./build/release/benchmark/benchmark_all

# 停止并保存
wpr -stop trace.etl

# 查看 (使用Windows Performance Analyzer)
wpa trace.etl
```

---

## 7. 本地Git配置

### 7.1 推荐的.gitignore

```gitignore
# 构建目录
build/
cmake-build-*/

# IDE
.vscode/
.vs/
*.sln
*.vcxproj
*.vcxproj.filters
*.vcxproj.user

# 编译产物
*.exe
*.dll
*.so
*.a
*.lib
*.obj
*.o

# 测试/Benchmark结果
results.json
*.etl
*.log

# 临时文件
*.swp
*.swo
*~
```

### 7.2 Pre-commit Hook (可选)

**创建** `.git/hooks/pre-commit`:
```bash
#!/bin/bash
# 格式化所有修改的C++文件
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp|h|cc)$' | while read file; do
    clang-format -i "$file"
    git add "$file"
done
```

---

## 8. 快速开始检查清单

完成以下步骤确保环境配置正确：

- [ ] 1. 安装Clang++ 14+
- [ ] 2. 安装CMake 3.20+
- [ ] 3. 安装Ninja
- [ ] 4. 安装VSCode + clangd插件
- [ ] 5. 克隆项目仓库
- [ ] 6. 配置CMake: `cmake --preset windows-clang-debug`
- [ ] 7. 构建项目: `cmake --build build/debug`
- [ ] 8. 运行测试: `ctest --test-dir build/debug`
- [ ] 9. 验证通过: 所有测试应该PASS

---

## 9. 常见问题

### Q1: Clang找不到标准库头文件

**解决方案**:
```bash
# 设置环境变量
set INCLUDE=C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\14.xx\include

# 或在CMakeLists.txt中指定
target_include_directories(lscq INTERFACE
    "C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.xx/include"
)
```

### Q2: Ninja构建失败

**解决方案**:
```bash
# 确保Ninja在PATH中
where ninja

# 或指定完整路径
cmake .. -G Ninja -DCMAKE_MAKE_PROGRAM="C:/path/to/ninja.exe"
```

### Q3: 无法运行cmpxchg16b测试

**解决方案**:
```bash
# 检查CPU是否支持
# Windows: 使用CPU-Z查看
# Linux: cat /proc/cpuinfo | grep cx16

# 如果不支持，会自动使用fallback
```

---

## 10. 环境变量建议

**Windows PowerShell配置** (`$PROFILE`):
```powershell
# LLVM/Clang路径
$env:LLVM_HOME = "C:\Program Files\LLVM"
$env:Path += ";$env:LLVM_HOME\bin"

# CMake
$env:Path += ";C:\Program Files\CMake\bin"

# Ninja
$env:Path += ";C:\Tools\ninja"

# 设置默认编译器
$env:CC = "clang"
$env:CXX = "clang++"
```

---

## 11. 本地测试硬件规格

**最低配置**:
- CPU: 4核心 (支持x86-64)
- 内存: 8GB
- 硬盘: 10GB可用空间

**推荐配置** (用于性能测试):
- CPU: 8核心+ (Intel/AMD，支持cmpxchg16b)
- 内存: 16GB+
- 硬盘: SSD

**验证CPU特性**:
```bash
# Windows: 下载CPU-Z
# 检查是否支持: CMPXCHG16B (CX16)

# Linux:
cat /proc/cpuinfo | grep -o 'cx16'
```

---

**文档变更记录**:

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| v1.0 | 2026-01-17 | Team | 初始版本，定义Windows + Clang开发环境 |
